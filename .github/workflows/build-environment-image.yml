name: Build Environment Image

on:
  push:
    branches: [main]
    paths:
      - '.devops/docker/environment/**'
  workflow_dispatch:
    inputs:
      ruby_version:
        description: 'Ruby Version'
        required: true
        default: '3.2.0'
      erlang_version:
        description: 'Erlang Version'
        required: true
        default: '28.0.2'
      elixir_version:
        description: 'Elixir Version'
        required: true
        default: '1.18.4'
      asdf_version:
        description: 'ASDF Version'
        required: true
        default: 'v0.18.0'

env:
  REGISTRY: docker.io
  ENVIRONMENT_IMAGE_NAME: trifle/environment

jobs:
  build-environment:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set versions
        id: versions
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ruby-version=${{ github.event.inputs.ruby_version }}" >> $GITHUB_OUTPUT
            echo "erlang-version=${{ github.event.inputs.erlang_version }}" >> $GITHUB_OUTPUT
            echo "elixir-version=${{ github.event.inputs.elixir_version }}" >> $GITHUB_OUTPUT
            echo "asdf-version=${{ github.event.inputs.asdf_version }}" >> $GITHUB_OUTPUT
          else
            echo "ruby-version=3.2.0" >> $GITHUB_OUTPUT
            echo "erlang-version=28.0.2" >> $GITHUB_OUTPUT
            echo "elixir-version=1.18.4" >> $GITHUB_OUTPUT
            echo "asdf-version=v0.18.0" >> $GITHUB_OUTPUT
          fi

      - name: Generate environment image tag
        id: generate-tag
        run: |
          RUBY_VERSION="${{ steps.versions.outputs.ruby-version }}"
          ERLANG_VERSION="${{ steps.versions.outputs.erlang-version }}"
          ELIXIR_VERSION="${{ steps.versions.outputs.elixir-version }}"
          ENV_TAG="ruby_${RUBY_VERSION}-erlang_${ERLANG_VERSION}-elixir_${ELIXIR_VERSION}"
          echo "environment-tag=${ENV_TAG}" >> $GITHUB_OUTPUT
          echo "Environment tag: ${ENV_TAG}"

      - name: Extract metadata for environment image
        id: meta-env
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.ENVIRONMENT_IMAGE_NAME }}
          tags: |
            type=raw,value=${{ steps.generate-tag.outputs.environment-tag }}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push environment image
        uses: docker/build-push-action@v5
        with:
          context: .devops/docker/environment
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta-env.outputs.tags }}
          labels: ${{ steps.meta-env.outputs.labels }}
          build-args: |
            ASDF_VERSION=${{ steps.versions.outputs.asdf-version }}
            RUBY_VERSION=${{ steps.versions.outputs.ruby-version }}
            ERLANG_VERSION=${{ steps.versions.outputs.erlang-version }}
            ELIXIR_VERSION=${{ steps.versions.outputs.elixir-version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Summary
        run: |
          echo "âœ… Built and pushed environment image:"
          echo "- ${{ env.ENVIRONMENT_IMAGE_NAME }}:${{ steps.generate-tag.outputs.environment-tag }}"
          echo "- ${{ env.ENVIRONMENT_IMAGE_NAME }}:latest"
          echo ""
          echo "Ruby: ${{ steps.versions.outputs.ruby-version }}"
          echo "Erlang: ${{ steps.versions.outputs.erlang-version }}"
          echo "Elixir: ${{ steps.versions.outputs.elixir-version }}"
          echo "ASDF: ${{ steps.versions.outputs.asdf-version }}"
