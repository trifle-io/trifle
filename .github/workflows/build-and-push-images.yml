name: Build and Push Docker Images

on:
  push:
    branches: [main]
    tags: ['v*']
    paths-ignore:
      - '.devops/docker/environment/**'
  pull_request:
    branches: [main]
    paths-ignore:
      - '.devops/docker/environment/**'

env:
  REGISTRY: docker.io
  ENVIRONMENT_IMAGE_NAME: trifle/environment
  APP_IMAGE_NAME: trifle/app

jobs:
  build-app:
    runs-on: ubuntu-latest
    outputs:
      app_version: ${{ steps.app_version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Determine app version
        id: app_version
        run: echo "version=$(cat VERSION | tr -d '\n')" >> $GITHUB_OUTPUT

      - name: Login to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Node.js (for assets)
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Set up Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: '1.18.4'
          otp-version: '28.0'

      - name: Install Elixir dependencies
        run: mix deps.get

      - name: Build assets
        run: |
          echo "Building assets with MIX_ENV=prod..."
          MIX_ENV=prod mix assets.deploy
          
      - name: Verify assets were built
        run: |
          echo "Checking built assets..."
          ls -la priv/static/assets/ || echo "No assets directory found"
          echo "CSS files:"
          find priv/static -name "*.css" | head -5
          echo "JS files:"
          find priv/static -name "*.js" | head -3
          echo "All files in priv/static:"
          find priv/static -type f | head -10

      - name: Extract metadata for app image
        id: meta-app
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.APP_IMAGE_NAME }}
          tags: |
            type=raw,value=${{ steps.app_version.outputs.version }}
            type=ref,event=branch
            type=ref,event=pr
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Create production Dockerfile
        run: |
          ENV_IMAGE="${{ env.ENVIRONMENT_IMAGE_NAME }}:ruby_3.2.0-erlang_28.0.2-elixir_1.18.4"
          
          cat > Dockerfile.production << EOF
          # Production Dockerfile for Trifle (Generated by GitHub Actions)
          FROM ${ENV_IMAGE} AS builder
          
          # Set build environment
          ENV MIX_ENV=prod
          
          WORKDIR /app
          
          # Copy mix files and install dependencies
          COPY mix.exs mix.lock VERSION ./
          RUN mix deps.get --only prod
          
          # Copy application source code (with pre-built assets)
          COPY . .
          
          # Compile and create release (assets already built)
          RUN mix compile
          RUN mix release
          
          # Production stage
          FROM debian:sid-slim AS runtime
          
          # Install runtime dependencies including Chromium for server-side export
          RUN apt-get update -y && \
              DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
                libstdc++6 \
                openssl \
                libncurses6 \
                ca-certificates \
                curl \
                chromium \
                libgbm1 \
                libnss3 \
                fonts-liberation \
                fonts-noto \
                fonts-noto-color-emoji \
              && apt-get clean && \
              rm -rf /var/lib/apt/lists/*
          
          # Create app user
          RUN useradd --create-home --shell /bin/bash app
          USER app
          WORKDIR /home/app
          
          # Copy the built release from builder stage
          COPY --from=builder --chown=app:app /app/_build/prod/rel/trifle ./
          
          # Set environment variables
          ENV MIX_ENV=prod
          ENV PHX_SERVER=true
          ENV LANG=en_US.UTF-8
          ENV LC_ALL=en_US.UTF-8
          ENV ELIXIR_ERL_OPTIONS=+fnu
          # Explicitly set Chromium path for exporter
          ENV CHROME_PATH=/usr/bin/chromium
          
          # Health check
          HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
              CMD curl -f http://localhost:4000/api/health || exit 1
          
          # Expose port
          EXPOSE 4000
          
          # Start the application
          CMD ["./bin/trifle", "start"]
          EOF

      - name: Build and push app image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.production
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta-app.outputs.tags }}
          labels: ${{ steps.meta-app.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  security-scan:
    if: github.event_name != 'pull_request'
    needs: [build-app]
    runs-on: ubuntu-latest
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.APP_IMAGE_NAME }}:${{ needs.build-app.outputs.app_version }}'
          format: 'table'
          output: 'trivy-results.txt'
          skip-version-check: true

      - name: Display security scan results
        if: always()
        run: |
          echo "ðŸ›¡ï¸ Security Scan Results:"
          echo "========================="
          if [ -f trivy-results.txt ]; then
            cat trivy-results.txt
          else
            echo "No scan results found"
          fi

      - name: Run Trivy vulnerability scanner (SARIF format for GitHub Security)
        if: false  # Disabled for now - requires GitHub Advanced Security
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.APP_IMAGE_NAME }}:${{ needs.build-app.outputs.app_version }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
          skip-version-check: true

      - name: Upload Trivy scan results to GitHub Security tab
        if: false  # Disabled for now - requires GitHub Advanced Security  
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Check for critical vulnerabilities
        if: always()
        run: |
          if [ -f trivy-results.txt ]; then
            if grep -q "CRITICAL" trivy-results.txt; then
              echo "âš ï¸  CRITICAL vulnerabilities found!"
              echo "Please review the security scan results above."
              echo "Continuing build - review and fix vulnerabilities in production."
              # Don't fail the build for now - just warn
              # exit 1
            else
              echo "âœ… No critical vulnerabilities found."
            fi
          fi
