name: Build and Push Docker Images

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

env:
  REGISTRY: docker.io
  ENVIRONMENT_IMAGE_NAME: trifle/environment
  APP_IMAGE_NAME: trifle/app

jobs:
  build-environment:
    runs-on: ubuntu-latest
    outputs:
      environment-tag: ${{ steps.generate-tag.outputs.environment-tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Generate environment image tag
        id: generate-tag
        run: |
          RUBY_VERSION=3.2.0
          ERLANG_VERSION=28.0.2
          ELIXIR_VERSION=1.18.4
          ENV_TAG="ruby_${RUBY_VERSION}-erlang_${ERLANG_VERSION}-elixir_${ELIXIR_VERSION}"
          echo "environment-tag=${ENV_TAG}" >> $GITHUB_OUTPUT
          echo "Environment tag: ${ENV_TAG}"

      - name: Extract metadata for environment image
        id: meta-env
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.ENVIRONMENT_IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=${{ steps.generate-tag.outputs.environment-tag }}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push environment image
        uses: docker/build-push-action@v5
        with:
          context: .devops/docker/environment
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta-env.outputs.tags }}
          labels: ${{ steps.meta-env.outputs.labels }}
          build-args: |
            ASDF_VERSION=v0.18.0
            RUBY_VERSION=3.2.0
            ERLANG_VERSION=28.0.2
            ELIXIR_VERSION=1.18.4
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-app:
    needs: build-environment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Node.js (for assets)
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Set up Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: '1.18.4'
          otp-version: '28.0'

      - name: Install dependencies
        run: mix deps.get

      - name: Build assets
        run: |
          MIX_ENV=prod mix assets.setup
          MIX_ENV=prod mix assets.deploy

      - name: Extract metadata for app image
        id: meta-app
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.APP_IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Create production Dockerfile
        run: |
          ENV_IMAGE="${{ env.ENVIRONMENT_IMAGE_NAME }}:${{ needs.build-environment.outputs.environment-tag }}"
          
          cat > Dockerfile.production << EOF
          # Production Dockerfile for Trifle (Generated by GitHub Actions)
          FROM ${ENV_IMAGE} AS builder
          
          # Set build environment
          ENV MIX_ENV=prod
          
          WORKDIR /app
          
          # Copy mix files and install dependencies
          COPY mix.exs mix.lock ./
          RUN mix deps.get --only prod
          
          # Copy application source code (with pre-built assets)
          COPY . .
          
          # Compile and create release (assets already built)
          RUN mix compile
          RUN mix release
          
          # Production stage
          FROM debian:latest AS runtime
          
          # Install runtime dependencies
          RUN apt-get update -y && \
              apt-get install -y \
              libstdc++6 \
              openssl \
              libncurses6 \
              ca-certificates \
              curl \
              && apt-get clean && \
              rm -rf /var/lib/apt/lists/*
          
          # Create app user
          RUN useradd --create-home --shell /bin/bash app
          USER app
          WORKDIR /home/app
          
          # Copy the built release from builder stage
          COPY --from=builder --chown=app:app /app/_build/prod/rel/trifle ./
          
          # Set environment variables
          ENV MIX_ENV=prod
          ENV PHX_SERVER=true
          
          # Health check
          HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
              CMD curl -f http://localhost:4000/api/health || exit 1
          
          # Expose port
          EXPOSE 4000
          
          # Start the application
          CMD ["./bin/trifle", "start"]
          EOF

      - name: Build and push app image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.production
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta-app.outputs.tags }}
          labels: ${{ steps.meta-app.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  security-scan:
    if: github.event_name != 'pull_request'
    needs: [build-app]
    runs-on: ubuntu-latest
    steps:
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.APP_IMAGE_NAME }}:latest'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'